<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estimating treatment heterogeneity for survival outcomes • survlearners</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Estimating treatment heterogeneity for survival outcomes">
<meta property="og:description" content="survlearners">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">survlearners</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/metalearners.html">Treatment heterogeneity for Survival Outcomes</a>
    </li>
    <li>
      <a href="../articles/select_metalearners.html">Metalearners selection</a>
    </li>
    <li>
      <a href="../articles/case_study.html">A case study with metalearners</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="metalearners_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Estimating treatment heterogeneity for survival outcomes</h1>
            
      
      
      <div class="hidden name"><code>metalearners.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">survlearners</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>This vignette provides a tutorial on how to estimate heterogeneous treatment effects for survival outcomes using the five popular metalearners (S-, T-, X-, R, and M-learners) available in the R package <a href="https://github.com/som-shahlab/survlearners">survlearners</a>. Metalearners are specific meta-algorithms that leverage predictive models to solve the causal task of treatment effect estimation. For all metalearners, we consider two popular machine learning methods, Lasso <span class="citation">(Tibshirani 1997; Goeman 2010)</span> and random (survival) forest <span class="citation">(Breiman 2001; Ishwaran et al. 2008; Athey, Tibshirani, and Wager 2019)</span>, for developing predictive models. Moreover, while the metaleaners have been developed for uncensored continuous or binary data, we explain how they are adapted in survlearners to the the survival setting through inverse probability of censoring weighting. For a detailed tutorial of these metalearners with mathematical underpinning, as well as a benchmarking study via a comprehensive simulation study, please refer to the Chapter named <a href="https://arxiv.org/abs/2207.07758" class="external-link">Treatment heterogeneity for survival outcomes</a> in the <strong>Handbook of Matching and Weighting Adjustments for Causal Inference</strong>. In this tutorial is, we will first describe the problem set up then demonstrate the usage of each metalearners through simulation examples.</p>
<div class="section level2">
<h2 id="problem-set-up">Problem set up<a class="anchor" aria-label="anchor" href="#problem-set-up"></a>
</h2>
<p>We discuss the problem of conditional average treatment effect (CATE) estimation under the potential outcome framework in causal inference <span class="citation">(Neyman 1923; Rubin 1974)</span>. Consider a randomized controlled trial that provides <span class="math inline">\(N\)</span> independent and identically distributed subject-level data, indexed by <span class="math inline">\(i \in \mathcal{I} = \{1, 2, \dotsc, N\}\)</span>. Patient baseline covariates are denoted by <span class="math inline">\(X_i = (X_{i1},\dotsc,X_{id}) \in \mathbb{R}^d\)</span> and the treatment variable is <span class="math inline">\(W_i \in \{0,1\}\)</span>. Let <span class="math inline">\(T_i(w)\)</span> be the potential survival time if subject <span class="math inline">\(i\)</span> had been assigned the treatment <span class="math inline">\(w\)</span> and <span class="math inline">\(C_i\)</span> be the censoring time. Then, <span class="math inline">\(T_i = W_i T_i(1)+ (1-W_i)T_i(0)\)</span>, and the observed follow-up time is <span class="math inline">\(U_i=\mathrm{min}(T_i, C_i)\)</span> with the corresponding non-censoring indicator <span class="math inline">\(\Delta_i = \mathbb{1}\{T_i \leq C_i\}\)</span>. Our observed dataset is <span class="math inline">\(\mathcal{O} = \{(X_i, W_i, U_i, \Delta_i): i \in \mathcal{I}\}\)</span>. We also reserve the notation <span class="math inline">\(\mathcal{I}_0 = \{ i \in \mathcal{I}: W_i=0\}\)</span> for the index set of control units and <span class="math inline">\(\mathcal{O}_0 = \{(X_i, 0, U_i, \Delta_i): i \in \mathcal{I}_0\}\)</span> for the control dataset. We define <span class="math inline">\(\mathcal{I}_1\)</span> and <span class="math inline">\(\mathcal{O}_1\)</span> analogously for the treated units.</p>
<p>The Conditional Average Treatment Effect (CATE) for the probability of survival beyond a pre-specified time <span class="math inline">\(t_0\)</span> is:</p>
<p><span class="math display">\[\tau(x) = \mathbb{E}[Y_i(1)-Y_i(0) \mid X_i=x],\]</span> where <span class="math inline">\(Y_i(w) = \mathbb{1}\{T_i(w) &gt; t_0\}\)</span> is the indicator of survival beyond time <span class="math inline">\(t_0\)</span>. We also write <span class="math inline">\(Y_i = Y_i(W_i)\)</span>.</p>
<p>To ensure the CATE is identifiable, we make the following assumptions <span class="citation">(Rosenbaum and Rubin 1983)</span>:</p>
<p><em>Consistency</em>: The observed survival time in real data is almost always the same as the potential outcome under the actual treatment assignment, i.e., <span class="math inline">\(T_i=T_i(W_i)\)</span>.</p>
<p><em>Randomized controlled trial (RCT)</em>: The treatment assignment is randomized and such that <span class="math inline">\(W_i\)</span> is independent of <span class="math inline">\((X_i, T_i(1), T_i(0))\)</span>, i.e., <span class="math inline">\(W_i \perp \!\!\! \perp (X_i, T_i(1), T_i(0))\)</span> and <span class="math inline">\(\mathbb P[W_i=1] = e\)</span> with known <span class="math inline">\(0&lt;e&lt;1\)</span>.</p>
<p><em>Noninformative censoring</em>: Censoring is independent of survival time conditional on treatment assignment and covariates, i.e., <span class="math inline">\(C_i \perp \!\!\! \perp T_i\,\mid\,X_i, W_i\)</span>.</p>
<p><em>Positivity</em>: There exists subjects who are at risk beyond the time horizon <span class="math inline">\(t_0\)</span>, i.e., <span class="math inline">\(\mathbb{P}[C_i &gt; t_0\,\mid\,X_i, W_i] \geq \eta_{C}\)</span> for some <span class="math inline">\(\eta_{C}&gt;0\)</span>.</p>
<p>To apply metalearners under observational studies, we replace the above RCT assumption by the following two assumptions:</p>
<p><em>Unconfoundedness</em>: The potential survival times are independent of the treatment assignment <span class="math inline">\(W_i\)</span> conditionally on baseline covariates, that is, <span class="math inline">\(W_i \perp \!\!\! \perp (T_i(1), T_i(0)) | X_i\)</span>.</p>
<p><em>Overlap</em>: There exists <span class="math inline">\(\eta \in (0,1)\)</span> such that the propensity score <span class="math inline">\(e(x) = \mathbb P[W_i=1 |X_i=x]\)</span> satisfies <span class="math inline">\(\eta \leq e(x) \leq 1-\eta\)</span> for all <span class="math inline">\(x\)</span> in the support of <span class="math inline">\(X_i\)</span>.</p>
</div>
<div class="section level2">
<h2 id="s-learner">S-learner<a class="anchor" aria-label="anchor" href="#s-learner"></a>
</h2>
<p><em>S-learner</em> is the “simplest” metalearner used in practice where a <em>single</em> risk model is learned using any method as a function of baseline covariates <span class="math inline">\(X_i\)</span> and the treatment variable <span class="math inline">\(W_i\)</span>, i.e., <span class="math display">\[u([x, w]) = \mathbb{E}[Y_i|\,X_i=x, W_i=w],\]</span> Then, S-learner applies the fitted model and estimates the CATE as the difference between the imputed responses of treated and untreated subjects, i.e., <span class="math display">\[\hat{\tau}(x) = \hat{\mu}([x, 1]) - \hat{\mu}([x, 0]).\]</span> Note that S-learner treats the treatment assignment <span class="math inline">\(W_i\)</span> as “just another covariate” <span class="citation">(Hill 2011; Hahn, Murray, and Carvalho 2020)</span>.</p>
<p>Data generating process: the survival time is drawn from a proportional hazard (PH) model as a function of covariates <span class="math inline">\(X_1\)</span>, <span class="math inline">\(X_2\)</span>, and treatment <span class="math inline">\(W\)</span></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">Y.max</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">p</span><span class="op">)</span>, <span class="va">n</span>, <span class="va">p</span><span class="op">)</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">numeratorT</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="cn">T</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">numeratorT</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="op">(</span><span class="op">-</span><span class="fl">0.5</span> <span class="op">-</span> <span class="va">X</span><span class="op">[</span> ,<span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">W</span><span class="op">)</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span></span>
<span><span class="va">failure.time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="cn">T</span>, <span class="va">Y.max</span><span class="op">)</span></span>
<span><span class="va">numeratorC</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">censor.time</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">numeratorC</span> <span class="op">/</span> <span class="op">(</span><span class="fl">4</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">^</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">failure.time</span>, <span class="va">censor.time</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">failure.time</span> <span class="op">&lt;=</span> <span class="va">censor.time</span><span class="op">)</span></span>
<span><span class="va">n.test</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">X.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n.test</span> <span class="op">*</span> <span class="va">p</span><span class="op">)</span>, <span class="va">n.test</span>, <span class="va">p</span><span class="op">)</span></span></code></pre></div>
<p>Generate the true CATE in the simulated test data</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t0</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">true.cate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">cox.ft0</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">10000</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">X.test</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="op">(</span><span class="op">-</span><span class="fl">0.5</span> <span class="op">-</span> <span class="va">X.test</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span>          <span class="va">cox.ft1</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">10000</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">X.test</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="op">(</span><span class="op">-</span><span class="fl">0.5</span> <span class="op">-</span> <span class="va">X.test</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span>          <span class="va">true.cate</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">cox.ft1</span>, <span class="va">Y.max</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">t0</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">cox.ft0</span>, <span class="va">Y.max</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">t0</span><span class="op">)</span></span>
<span>          <span class="op">}</span></span></code></pre></div>
<p>When <span class="math inline">\(\hat{\mu}\)</span> is learned using a Lasso Cox PH model, implemented via the <em>glmnet</em> R package <span class="citation">(Friedman et al. 2022)</span>, at the time of interest <span class="math inline">\(t_0=0.2\)</span></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv.sl.lasso.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_sl_lasso.html">surv_sl_lasso</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, <span class="va">W</span>, <span class="va">D</span>, <span class="va">t0</span><span class="op">)</span></span>
<span><span class="va">cate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.sl.lasso.fit</span><span class="op">)</span></span>
<span><span class="va">cate.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.sl.lasso.fit</span>, <span class="va">X.test</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the estimated CATE against true CATE</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>cate.test <span class="op">=</span> <span class="va">cate.test</span>, true.cate <span class="op">=</span> <span class="va">true.cate</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cate.test</span>, y <span class="op">=</span> <span class="va">true.cate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Estimated CATE by S-learner with Lasso"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"True CATE"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="metalearners_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>When <span class="math inline">\(\hat{\mu}\)</span> is learned using a random survival forest, implemented via the <em>grf</em> R package <span class="citation">(Tibshirani et al. 2022)</span></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t0</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">surv.sl.grf.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_sl_grf.html">surv_sl_grf</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, <span class="va">W</span>, <span class="va">D</span>, <span class="va">t0</span><span class="op">)</span></span>
<span><span class="va">cate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.sl.grf.fit</span><span class="op">)</span></span>
<span><span class="va">cate.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.sl.grf.fit</span>, <span class="va">X.test</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the estimated CATE against true CATE</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>cate.test <span class="op">=</span> <span class="va">cate.test</span>, true.cate <span class="op">=</span> <span class="va">true.cate</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cate.test</span>, y <span class="op">=</span> <span class="va">true.cate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Estimated CATE by S-learner with Random Survival Forest"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"True CATE"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="metalearners_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="t-learner">T-learner<a class="anchor" aria-label="anchor" href="#t-learner"></a>
</h2>
<p><em>T-learner</em> is another widely-used metalearner that fits <em>two</em> risk models as a function of baseline covariates <span class="math inline">\(X_i\)</span>, separately for treated and untreated subjects, i.e., <span class="math display">\[u_{(w)}(x) = \mathbb{P}[T_i(w) &gt; t_0|\,X_i=x],\]</span> So, <span class="math inline">\(u_{(1)}(x)\)</span> is trained using data only from treated subjects, while <span class="math inline">\(u_{(0)}(x)\)</span> is fitted using data only from control subjects. T-learner then applies both fitted models and estimates the CATE as the difference between the imputed responses of treated and untreated subjects, i.e., <span class="math display">\[\hat{\tau}(x) = \hat{\mu}_{(1)}(x) - \hat{\mu}_{(0)}(x).\]</span> T-learner with Cox-Lasso:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv.tl.lasso.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_tl_lasso.html">surv_tl_lasso</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, <span class="va">W</span>, <span class="va">D</span>, <span class="va">t0</span><span class="op">)</span></span>
<span><span class="va">cate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.tl.lasso.fit</span><span class="op">)</span></span>
<span><span class="va">cate.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.tl.lasso.fit</span>, <span class="va">X.test</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the estimated CATE against true CATE</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>cate.test <span class="op">=</span> <span class="va">cate.test</span>, true.cate <span class="op">=</span> <span class="va">true.cate</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cate.test</span>, y <span class="op">=</span> <span class="va">true.cate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Estimated CATE by T-learner with Lasso"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"True CATE"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="metalearners_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>T-learner with random survival forest:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv.tl.grf.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_tl_grf.html">surv_tl_grf</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, <span class="va">W</span>, <span class="va">D</span>, <span class="va">t0</span><span class="op">)</span></span>
<span><span class="va">cate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.tl.grf.fit</span><span class="op">)</span></span>
<span><span class="va">cate.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.tl.grf.fit</span>, <span class="va">X.test</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the estimated CATE against true CATE</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>cate.test <span class="op">=</span> <span class="va">cate.test</span>, true.cate <span class="op">=</span> <span class="va">true.cate</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cate.test</span>, y <span class="op">=</span> <span class="va">true.cate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Estimated CATE by T-learner with Random Survival Forest"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"True CATE"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="metalearners_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>S-learner estimates treatment heterogeneity through including treatment-covariate interactions into risk models, and T-learner estimates treatment heterogeneity by building stratified risk models by treatment. One advantage of these two metalearners is that the extension to survival outcomes is straightforward, that is, applying risk models that account for right censoring. The downsides are: 1) they both require sufficient numbers of treated and untreated subjects to ensure reliable risk models, 2) they do not directly estimate a CATE function; therefore, do not allow a direct regularization of the CATE function nor the incorporation of any known structure of the CATE function, 3) they may result in complicated CATE models due to complex risk functions, and 4) T-learner may suffer the regularization-induced bias due to the inconsistent basis functions between <span class="math inline">\(\hat{u}_{(1)}(x)\)</span> and <span class="math inline">\(\hat{u}_{(0)}(x)\)</span>.</p>
<p>In order to directly learn the CATE function by predictive modeling of <span class="math inline">\(Y_i^{*}= Y_i(1) - Y_i(0)\)</span> as a function of <span class="math inline">\(X_i\)</span>, we are facing two challenges: First, due to censoring we do not observe <span class="math inline">\(Y_i\)</span> for the censored <span class="math inline">\(i\)</span>; instead we observe <span class="math inline">\((U_i, \Delta_i)\)</span>. Second, by the fundamental problem of causal inference, we observe at most one potential outcome (each <span class="math inline">\(i\)</span> is either treated or not), namely <span class="math inline">\(Y_i = Y_i(W_i)\)</span>. It turns out however, M-, X-, and R-learners can handle the “missing data” issue and enable directly modeling of the CATE.</p>
</div>
<div class="section level2">
<h2 id="censoring-adjustments">Censoring adjustments<a class="anchor" aria-label="anchor" href="#censoring-adjustments"></a>
</h2>
<p>The “missing data” or “right censoring” issue can be handled using Inverse Probability Censoring Weights (IPCW) <span class="citation">(Kohler, Máthé, and Pintér 2002; Van der Laan and Robins 2003)</span>. Specifically, We create a dataset with only  cases, which are defined as subjects who had an event before <span class="math inline">\(t_0\)</span> or finished the follow-up until <span class="math inline">\(t_0\)</span> without developing an event, i.e., <span class="math inline">\(\mathcal{I}_{\text{comp}} = \{i \in \mathcal{I} : \Delta_i=1 \text{ or } U_i \geq t_0\}\)</span> and <span class="math inline">\(\mathcal{O}_{\text{comp}} = \{(X_i, W_i, U_i, \Delta_i): i \in \mathcal{I}\}\)</span>. Next, we estimate the survival function of the censoring time as follows: <span class="math display">\[ S^C(u, x, w) = \mathbb{P}[C_i \geq u \mid X_i=x, W_i=w]\]</span> Based on <span class="math inline">\(\hat{S}^C(\cdot)\)</span>, we then re-weight every subject <span class="math inline">\(i \in \mathcal{I}_{\text{comp}}\)</span> by <span class="math inline">\(\hat{K}_i\)</span>, an estimate of the inverse of the probability of not being censored, namely: <span class="math display">\[\hat{K}_i = 1\Big/\hat{S}^C\left(\min\{U_i, t_0\}, X_i, W_i\right).\]</span> The IPCW adjustment removes censoring bias, but it can be inefficient and unstable when the censoring rate is high in a study and a majority of the censoring events happened before <span class="math inline">\(t_0\)</span>. It also may be more sensitive to misspecification of the censoring model. In such cases, one can consider a doubly robust correction similar to the augmented inverse-propensity weighting estimator of <span class="citation">Robins, Rotnitzky, and Zhao (1994)</span>. We do not dive into the details here and refer interested readers to <span class="citation">Tsiatis (2006)</span>.</p>
<p>For each of the three learners (M, X, R), survlearners provide two options for estimating censoring weights, a Kaplan-Meier (KM) estimator or a random survival forest. The KM estimator is appropriate under completely independent censoring, i.e., <span class="math inline">\(C_i \perp \!\!\! \perp \{T_i, X_i, W_i\}\)</span>. Otherwise, a random survival forest should be used to model the dependence between <span class="math inline">\(C_i\)</span> and the other variables. Besides, survlearners estimate <span class="math inline">\(\hat{K}_i\)</span> out-of-bag (e.g., cross-fitting) to avoid overfitting <span class="citation">(Chernozhukov et al. 2018)</span>.</p>
<p>If we hypothetically had access to the oracle scores <span class="math inline">\(Y_i^{*}\)</span> that satisfy <span class="math inline">\(\mathbb E[Y_i^* \mid X_i=x] = \tau(x)\; \text{  or  }\; \mathbb E[Y_i^* \mid X_i=x]\)</span> for the uncensored samples <span class="math inline">\(i \in \mathcal{I}_{\text{comp}}\)</span> and weights <span class="math inline">\(\hat{K}_i\)</span>, then we could estimate CATEs via weighted predictive modeling as <span class="math inline">\(\hat{\tau}(\cdot) = \mathcal{M}(Y^{*} \sim X; \; _{\text{comp}}, \hat{K})\)</span>, where <span class="math inline">\(\mathcal{M}\)</span> symbolizes an arbitrary model. In the subsections below, we describe how each metalearner resolves this challenge that—even in the absence of censoring—the oracle scores <span class="math inline">\(Y_i^{*}\)</span> are not available, due to the fundamental challenge of causal inference.</p>
</div>
<div class="section level2">
<h2 id="m-learner">M-learner<a class="anchor" aria-label="anchor" href="#m-learner"></a>
</h2>
<p>The <em>modified outcome method (M-learner)</em> <span class="citation">(Signorovitch 2007; Tian et al. 2014; Athey and Imbens 2016)</span> leverages the aforementioned insight with the following score based on the <span class="citation">Horvitz and Thompson (1952)</span> transformation / inverse propensity weighting (IPW): <span class="math display">\[Y^{*,M}_i = Y_i\left(\frac{W_i}{e} - \frac{1-W_i}{1-e}\right),\;\;\; \mathbb E[Y^{*,M}_i \mid X_i=x] = \tau(x),\]</span> Then, the M-learner proceeds as follows: <span class="math display">\[\hat{\tau}(x)= \mathcal{M}(Y^{*,M} \sim X;\; \mathcal{O}_{\text{comp}}, \hat{K})\]</span> M-learner with Cox-Lasso:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv.fl.lasso.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_fl_lasso.html">surv_fl_lasso</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, <span class="va">W</span>, <span class="va">D</span>, <span class="va">t0</span>, W.hat <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">cate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.fl.lasso.fit</span><span class="op">)</span></span>
<span><span class="va">cate.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.fl.lasso.fit</span>, <span class="va">X.test</span><span class="op">)</span></span></code></pre></div>
<p>M-learner with random survival forest:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv.fl.grf.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_fl_grf.html">surv_fl_grf</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, <span class="va">W</span>, <span class="va">D</span>, <span class="va">t0</span>, W.hat <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">cate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.fl.grf.fit</span><span class="op">)</span></span>
<span><span class="va">cate.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.fl.grf.fit</span>, <span class="va">X.test</span><span class="op">)</span></span></code></pre></div>
<p>A downside of the M-learner is the high variance (e.g., when <span class="math inline">\(e \approx 0\)</span>, then the scores <span class="math inline">\(Y_{i}^{*,M}\)</span> can blow up for treated units). In contrast, X- and R-learners that also directly estimate the CATE but with lower variance by including estimated risk models in the definition of the scores.</p>
</div>
<div class="section level2">
<h2 id="x-learner">X-learner<a class="anchor" aria-label="anchor" href="#x-learner"></a>
</h2>
<p>The <em>X-learner</em> <span class="citation">(Künzel et al. 2019)</span> constructs scores for treated and untreated subjects separately in a “crossing” fashion <span class="math display">\[Y_i^{*,X,1} = Y_i(1) - \mu_{(0)}(X_i), \;\; Y_i^{*,X,0} = \mu_{(1)}(X_i) - Y_i(0), \]</span> where <span class="math inline">\(\mu_{(w)}(x) = \mathbb E[Y_i(w) \mid X_i=x]\)</span> is estimated in the first stage as in the T-learner. With <span class="math inline">\(\hat{\mu}_{(0)}(X_i)\)</span> and <span class="math inline">\(Y_i^{*,X,1}\)</span>, in the second stage, X-learner estimates the CATE as <span class="math display">\[\hat{\tau}_{(1)}(\cdot) = \mathcal{M}(Y - \hat{\mu}_{(0)}(X) \sim X;\; \mathcal{O}_1 \cap \mathcal{O}_{\text{comp}}, \hat{K}),\]</span> Analogously, we can estimate <span class="math inline">\(\hat{\tau}_{(0)}(\cdot) = \mathcal{M}(\hat{\mu}_{(0)}(X) \sim X;\; \mathcal{O}_0 \cap \mathcal{O}_{\text{comp}}, \hat{K})\)</span>. In the last stage, the X-learner combines the two CATE estimates as follows: <span class="math display">\[\hat{\tau}(x) = (1-e)\cdot\hat{\tau}_{(1)}(x) + e\cdot\hat{\tau}_{(0)}(x).\]</span> The intuition here is that we should upweight <span class="math inline">\(\hat{\tau}_{(1)}(x)\)</span> if there are fewer treated units, and <span class="math inline">\(\hat{\tau}_{(0)}(x)\)</span> if there are more treated units.</p>
<p>X-learner with Cox-Lasso:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv.xl.lasso.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_xl_lasso.html">surv_xl_lasso</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, <span class="va">W</span>, <span class="va">D</span>, <span class="va">t0</span>, W.hat <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">cate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.xl.lasso.fit</span><span class="op">)</span></span>
<span><span class="va">cate.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.xl.lasso.fit</span>, <span class="va">X.test</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the estimated CATE against true CATE</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>cate.test <span class="op">=</span> <span class="va">cate.test</span>, true.cate <span class="op">=</span> <span class="va">true.cate</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cate.test</span>, y <span class="op">=</span> <span class="va">true.cate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Estimated CATE by X-learner with Lasso"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"True CATE"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="metalearners_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>X-learner with random survival forest:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv.xl.grf.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_xl_grf.html">surv_xl_grf</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, <span class="va">W</span>, <span class="va">D</span>, <span class="va">t0</span>, W.hat <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">cate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.xl.grf.fit</span><span class="op">)</span></span>
<span><span class="va">cate.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.xl.grf.fit</span>, <span class="va">X.test</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the estimated CATE against true CATE</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>cate.test <span class="op">=</span> <span class="va">cate.test</span>, true.cate <span class="op">=</span> <span class="va">true.cate</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cate.test</span>, y <span class="op">=</span> <span class="va">true.cate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Estimated CATE by X-learner with Random Survival Forest"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"True CATE"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="metalearners_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>X-learner with random survival forest and Lasso:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv.xl.grf.lasso.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_xl_grf_lasso.html">surv_xl_grf_lasso</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, <span class="va">W</span>, <span class="va">D</span>, <span class="va">t0</span>, W.hat <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">cate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.xl.grf.lasso.fit</span><span class="op">)</span></span>
<span><span class="va">cate.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.xl.grf.lasso.fit</span>, <span class="va">X.test</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="r-learner">R-learner<a class="anchor" aria-label="anchor" href="#r-learner"></a>
</h2>
<p>The <em>R-learner</em> <span class="citation">(Nie and Wager 2021)</span> is a metalearner that builds upon a characterization of the CATE in terms of residualization of <span class="math inline">\(W_i\)</span> and <span class="math inline">\(Y_i\)</span> <span class="citation">(Robinson 1988)</span>, i.e., <span class="math inline">\(W_i - e\)</span> and <span class="math inline">\(Y_i - m(x)\)</span>, where <span class="math inline">\(m(x) = \mathbb E[Y_i \mid X_i=x]\)</span>. There are two ways to describe the R-learner: the loss-based and the weighted representations.</p>
<p>For the loss-based representation <span class="citation">(Robins 2004)</span>, R-learner estimates <span class="math inline">\(\tau(\cdot)\)</span> by minimizing the following loss <span class="math display">\[\tau(\cdot) \in \mathrm{argmin}_{\widetilde{\tau}(\cdot)} \left\{\mathbb{E}\left[\hat{K}_i\left(\{Y_i-\hat{m}(X_i)\}-\{W_i-e\}\widetilde{\tau}(X_i)\right)^2\right] \right\},\]</span> where <span class="math inline">\(\hat{m}(\cdot) = e \hat{\mu}_{(1)}(\cdot) + (1-e)\hat{\mu}_{(0)}(\cdot)\)</span> is the outcome nuisance parameter estimated out-of-bag. The <span class="math inline">\(\hat{\mu}_{(w)}(\cdot)\)</span> is estimated as in the T-learner and <span class="math inline">\(\hat{K}_i\)</span> are the estimated censoring weights as above.</p>
<p>To show the weighted representation, we rewrite the above loss function using a weighted least squares objective as: <span class="math display">\[\tau(\cdot) \in \mathrm{argmin}_{\widetilde{\tau}(\cdot)} \left\{\mathbb{E}\left[\hat{K}_i(W_i-e)^2\left(\frac{Y_i-\hat{m}(X_i)}{W_i-e}-\widetilde{\tau}(X_i)\right)^2\right] \right\}, \]</span> where <span class="math inline">\(Y^{*, R} = \frac{Y_i-\hat{m}(X_i)}{W_i-e}\)</span> is the constructed score by the R-learner.</p>
<p>We point out several remarks about R-learner:</p>
<ol style="list-style-type: decimal">
<li><p>R-learner is robust to a biased estimation of the outcome nuisance parameter, i.e., even if <span class="math inline">\(\hat{m}(.)\)</span> is not a good approximation to <span class="math inline">\(m(\cdot)\)</span>, the R-learner may perform well <span class="citation">(Nie and Wager 2021)</span>. In fact, if <span class="math inline">\(e = 0.5\)</span> and we estimate <span class="math inline">\(\hat{m}(\cdot) \approx 0\)</span> (even though <span class="math inline">\(m(\cdot) \neq 0\)</span>), the R-learner predictions are very similar to the predictions of the M-learner. On the other hand, when <span class="math inline">\(\hat{m}(\cdot) \approx m(\cdot)\)</span>, then centering by <span class="math inline">\(\hat{m}(X_i)\)</span> helps stabilize the estimation compared to the M-learner.</p></li>
<li><p>For the weighted least squares objective with weights <span class="math inline">\((W_i-e)^2\)</span>, under unbalanced treatment assignment, e.g., when there are less treated units (<span class="math inline">\(e &lt; 0.5\)</span>), then the R-learner upweights the treated units compared to control units by the factor <span class="math inline">\((1-e)^2/e^2\)</span>. The upweighting of treated units by the R-learner is similar to the behaviour of the X-learner (shown above). In fact, the predictions of R-learner and X-learner (when used with the same predictive models) are almost identical in the case of strong imbalance <span class="math inline">\((e \approx 0)\)</span> <span class="citation">(Nie and Wager 2021)</span>.</p></li>
<li><p>When R-learner is implemented with the generalized random forest framework of <span class="citation">Athey, Tibshirani, and Wager (2019)</span>, there exists a function <em>causal_forest</em> from the <a href="https://github.com/grf-labs/grf" class="external-link">grf</a> package that enables direct modeling of <span class="math inline">\(\tau(x)\)</span>. For each <span class="math inline">\(x\)</span>, the causal forest estimates <span class="math inline">\(\hat{\tau}(x)\)</span> by fitting a weighted regression using the loss-based objective and with additional data-adaptive weighting localized around <span class="math inline">\(x\)</span> and determined by the collection of tree splits <span class="citation">(Athey, Tibshirani, and Wager 2019)</span>. To adapt it for survival outcomes, we extract the complete cases and apply the censoring weights <span class="math inline">\(\hat{K}_i\)</span> through the <em>sample.weights</em> option.</p></li>
<li><p>Causal Survival Forest (CSF) of <span class="citation">Cui et al. (2022)</span> is a special case of R-learner that handles right censoring using a doubly robust censoring adjustment mentioned above.</p></li>
<li><p>Both objectives shown above can be fitted with standard software with different transformations of the outcome and covariates. The implementation in survlearners utilizes the weighted objective.</p></li>
</ol>
<p>R-learner with Cox-Lasso:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv.rl.lasso.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_rl_lasso.html">surv_rl_lasso</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, <span class="va">W</span>, <span class="va">D</span>, <span class="va">t0</span>, W.hat <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">cate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.rl.lasso.fit</span><span class="op">)</span></span>
<span><span class="va">cate.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.rl.lasso.fit</span>, <span class="va">X.test</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the estimated CATE against true CATE</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>cate.test <span class="op">=</span> <span class="va">cate.test</span>, true.cate <span class="op">=</span> <span class="va">true.cate</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cate.test</span>, y <span class="op">=</span> <span class="va">true.cate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Estimated CATE by R-learner with Lasso"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"True CATE"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="metalearners_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>R-learner with random survival forest (causal_forest):</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv.rl.grf.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_rl_grf.html">surv_rl_grf</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, <span class="va">W</span>, <span class="va">D</span>, <span class="va">t0</span>, W.hat <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">cate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.rl.grf.fit</span><span class="op">)</span></span>
<span><span class="va">cate.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.rl.grf.fit</span>, <span class="va">X.test</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the estimated CATE against true CATE</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>cate.test <span class="op">=</span> <span class="va">cate.test</span>, true.cate <span class="op">=</span> <span class="va">true.cate</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cate.test</span>, y <span class="op">=</span> <span class="va">true.cate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Estimated CATE by the Inverse-probability-censoring-weighted Causal Forest"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"True CATE"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.8</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="metalearners_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>R-learner with random survival forest and Lasso:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv.rl.grf.lasso.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_rl_grf_lasso.html">surv_rl_grf_lasso</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, <span class="va">W</span>, <span class="va">D</span>, <span class="va">t0</span>, W.hat <span class="op">=</span> <span class="fl">0.5</span>, cen.fit <span class="op">=</span> <span class="st">"survival.forest"</span><span class="op">)</span></span>
<span><span class="va">cate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.rl.grf.lasso.fit</span><span class="op">)</span></span>
<span><span class="va">cate.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">surv.rl.grf.lasso.fit</span>, <span class="va">X.test</span><span class="op">)</span></span></code></pre></div>
<p>Hopefully, at this point, we are clear about the main ideas of the five metalearners and <em>how</em> to implement them for survival outcomes via the survlearners package. Given all these advanced statistical tools for estimating treatment heterogeneity, it is crucial to know <em>when</em> to apply each approach in light of the specific characteristics of a dataset. For interested readers, please refer to the <a href="https://som-shahlab.github.io/survlearners/articles/select_metalearners.html" class="external-link">Metalearners selection</a> tutorial for an overview of our benchmarking study of these metalearners under various data generating processes and a set of practical recommendations and considerations when choosing a CATE estimation approach in applied research.</p>
</div>
<div class="section level2">
<h2 id="funding">Funding<a class="anchor" aria-label="anchor" href="#funding"></a>
</h2>
<p>This work was supported by R01 HL144555 from the National Heart, Lung, and Blood Institute (NHLBI).</p>
</div>
<div class="section level2 unnumbered">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references">
<div id="ref-Athey2016">
<p>Athey, Susan, and Guido Imbens. 2016. “Recursive Partitioning for Heterogeneous Causal Effects: Table 1.” <em>Proceedings of the National Academy of Sciences</em> 113 (July): 7353–60.</p>
</div>
<div id="ref-Athey2019">
<p>Athey, Susan, Julie Tibshirani, and Stefan Wager. 2019. “Generalized Random Forests.” <em>The Annals of Statistics</em> 47 (2): 1148–78.</p>
</div>
<div id="ref-Breiman2001">
<p>Breiman, L. 2001. “Random Forests.” <em>Machine Learning</em>, 45: 5–32.</p>
</div>
<div id="ref-Chernozhukov2018">
<p>Chernozhukov, Victor, Denis Chetverikov, Mert Demirer, Esther Duflo, Christian Hansen, Whitney Newey, and James Robins. 2018. “Double/debiased machine learning for treatment and structural parameters.” <em>The Econometrics Journal</em> 21 (1): C1–C68.</p>
</div>
<div id="ref-cui2021estimating">
<p>Cui, Yifan, Michael R Kosorok, Erik Sverdrup, Stefan Wager, and Ruoqing Zhu. 2022. “Estimating Heterogeneous Treatment Effects with Right-Censored Data via Causal Survival Forests.” <em>arXiv Preprint arXiv:2001.09887</em>.</p>
</div>
<div id="ref-glmnet">
<p>Friedman, Jerome, Trevor Hastie, Rob Tibshirani, Balasubramanian Narasimhan, Kenneth Tay, Noah Simon, Junyang Qian, and James Yang. 2022. <em>Glmnet: Lasso and Elastic-Net Regularized Generalized Linear Models</em>. <a href="https://glmnet.stanford.edu" class="external-link">https://glmnet.stanford.edu</a>.</p>
</div>
<div id="ref-goeman2010l1">
<p>Goeman, Jelle J. 2010. “<span class="math inline">\(L_1\)</span> Penalized Estimation in the Cox Proportional Hazards Model.” <em>Biometrical Journal</em> 52 (1): 70–84.</p>
</div>
<div id="ref-hahn2020bayesian">
<p>Hahn, P Richard, Jared S Murray, and Carlos M Carvalho. 2020. “Bayesian Regression Tree Models for Causal Inference: Regularization, Confounding, and Heterogeneous Effects (with Discussion).” <em>Bayesian Analysis</em> 15 (3): 965–1056.</p>
</div>
<div id="ref-Hill2011">
<p>Hill, JL. 2011. “Bayesian Nonparametric Modeling for Causal Inference.” <em>Journal of Computational and Graphical Statistics</em> 20 (1): 217–40.</p>
</div>
<div id="ref-horvitz1952generalization">
<p>Horvitz, Daniel G, and Donovan J Thompson. 1952. “A Generalization of Sampling Without Replacement from a Finite Universe.” <em>Journal of the American Statistical Association</em> 47 (260): 663–85.</p>
</div>
<div id="ref-ishwaran2008random">
<p>Ishwaran, Hemant, Udaya B Kogalur, Eugene H Blackstone, and Michael S Lauer. 2008. “Random Survival Forests.” <em>The Annals of Applied Statistics</em> 2 (3): 841–60.</p>
</div>
<div id="ref-kohler2002prediction">
<p>Kohler, Michael, Kinga Máthé, and Márta Pintér. 2002. “Prediction from Randomly Right Censored Data.” <em>Journal of Multivariate Analysis</em> 80 (1): 73–100.</p>
</div>
<div id="ref-Kunzel2019">
<p>Künzel, Sören R, Jasjeet S Sekhon, Peter J Bickel, and Bin Yu. 2019. “Metalearners for Estimating Heterogeneous Treatment Effects Using Machine Learning.” <em>Proceedings of the National Academy of Sciences</em> 116 (10): 4156–65.</p>
</div>
<div id="ref-Neyman1923">
<p>Neyman, J. 1923. “Sur Les Applications de La Th’eorie Des Probabilit’es Aux Experiences Agricoles: Essai Des Principes.” <em>Roczniki Nauk Rolniczych</em> 10 (January).</p>
</div>
<div id="ref-Nie2020">
<p>Nie, Xinkun, and Stefan Wager. 2021. “Quasi-Oracle Estimation of Heterogeneous Treatment Effects.” <em>Biometrika</em> 108 (2): 299–319.</p>
</div>
<div id="ref-robins2004optimal">
<p>Robins, James M. 2004. “Optimal Structural Nested Models for Optimal Sequential Decisions.” In <em>Proceedings of the Second Seattle Symposium in Biostatistics</em>, 189–326. Springer.</p>
</div>
<div id="ref-Robins1994">
<p>Robins, James, A G Rotnitzky, and Lue Zhao. 1994. “Estimation of Regression Coefficients When Some Regressors Are Not Always Observed.” <em>Journal of the American Statistical Association</em> 89 (September): 846–66.</p>
</div>
<div id="ref-Robinson1988">
<p>Robinson, Peter. 1988. “Root-<span class="math inline">\(N\)</span>-Consistent Semiparametric Regression.” <em>Econometrica</em> 56 (February): 931–54.</p>
</div>
<div id="ref-ROSENBAUM1983">
<p>Rosenbaum, Paul, and Donald Rubin. 1983. “The Central Role of the Propensity Score in Observational Studies for Causal Effects.” <em>Biometrika</em> 70 (April): 41–55.</p>
</div>
<div id="ref-Rubin1974">
<p>Rubin, Donald B. 1974. “Estimating Causal Effects of Treatments in Randomized and Nonrandomized Studies.” <em>Journal of Educational Psychology</em> 66 (5): 688.</p>
</div>
<div id="ref-Signorovitch2007">
<p>Signorovitch, James. 2007. “Identifying Informative Biological Markers in High-Dimensional Genomic Data and Clinical Trials.” PhD thesis, Harvard University.</p>
</div>
<div id="ref-Tian2014">
<p>Tian, Lu, Ash Alizadeh, Andrew Gentles, and Robert Tibshirani. 2014. “A Simple Method for Estimating Interactions Between a Treatment and a Large Number of Covariates.” <em>Journal of the American Statistical Association</em> 109.</p>
</div>
<div id="ref-grf">
<p>Tibshirani, Julie, Susan Athey, Erik Sverdrup, and Stefan Wager. 2022. <em>Grf: Generalized Random Forests</em>. <a href="https://github.com/grf-labs/grf" class="external-link">https://github.com/grf-labs/grf</a>.</p>
</div>
<div id="ref-tibshirani1997lasso">
<p>Tibshirani, Robert. 1997. “The Lasso Method for Variable Selection in the Cox Model.” <em>Statistics in Medicine</em> 16 (4): 385–95.</p>
</div>
<div id="ref-tsiatis2006semiparametric">
<p>Tsiatis, Anastasios A. 2006. “Semiparametric Theory and Missing Data.”</p>
</div>
<div id="ref-Laan2003">
<p>Van der Laan, Mark J, and James M Robins. 2003. <em>Unified Methods for Censored Longitudinal Data and Causality</em>. Vol. 5. Springer.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Yizhe Xu, Nikolaos Ignatiadis, Erik Sverdrup, Scott Fleming, Stefan Wager, Nigam Shah.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
